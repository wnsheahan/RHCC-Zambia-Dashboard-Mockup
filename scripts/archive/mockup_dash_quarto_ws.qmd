---
title: "rhcc-quarto-dashboard-ws"
date: '`r format(Sys.Date(), "%Y-%b-%d")`'
format:
  dashboard:
      theme: cosmo
      logo: "C:/Users/wsheahan/Box/MNTD/Projects/RHCC (Rotary)/Dashboard/path_logo.png"
      orientation: rows
      scrolling: true
---

```{r setup, include=F}
pacman::p_load(tidyverse,knitr,flexdashboard,plotly,kableExtra,sf,wesanderson,PATHtools)

#Set global options for figure/table placement
opts_chunk$set(echo=F, message=F, warning=F, results='asis', dpi=150)
options(knitr.kable.NA = '')


#Load toy data
#Generate toy data.
dat = data.frame(adm0 = rep(c("DRC", "MOZ", "NGA", "ZMB"), each = 4), 
                 date = rep(c(seq.Date(from = "2020-01-01", to = "2020-04-01", by = "month")), times = 4),
                 rhcc1 = c(0,1.1/1000,0,2.3/1000,1.3/1000,0,1.4/1000,2.1/1000,NA,NA,1.7/1000,NA,1.1/1000,0,0,2.2/1000),
                 rhcc2m = c(15,17,18,22,31,30,30,34,10,12,13,14,50,55,54,62),
                 rhcc2p = c(8,10,12,20,23,28,27,30,5,7,8,6,20,24,24,18),
                 rhcc2d = c(25,27,25,22,40,42,44,42,20,24,26,32,80,84,83,82),
                 rhcc3 = c(500,NA,NA,NA,200,NA,NA,NA,400,NA,NA,NA,400,NA,NA,NA),
                 rhcc4 = c(450,425,440,470,200,198,195,190,390,392,395,400,395,400,400,400),
                 rhcc5 = c(15,NA,NA,NA,60,NA,NA,NA,85,NA,NA,NA,40,NA,NA,NA),
                 rhcc5_n = c(800,NA,NA,NA,200,NA,NA,NA,2310,NA,NA,NA,1980,NA,NA,NA),
                 rhcc5_d = c(360000,NA,NA,NA,47600,NA,NA,NA,595000,NA,NA,NA,177310,NA,NA,NA),
                 rhcc6 = c(15,NA,NA,NA,50,NA,NA,NA,NA,70,NA,NA,35,NA,NA,NA),
                 rhcc7 = c(6,6,7,8,NA,NA,2,3,15,17,19,19,25,25,25,26),
                 rhcc8 = c(81,NA,NA,85,NA,NA,60,65,53,57,61,70,80,85,95,95),
                 rhcc9 = c(67,65,67,70,85,88,90,95,50,51,48,50,75,80,80,90),
                 rhcc9.1 = c(60,62,63,64,81,87,88,90,40,45,46,47,70,78,78,83),
                 rhcc10 = c(55,NA,NA,NA,77,NA,NA,NA,NA,70,NA,NA,85,NA,NA,NA),
                 rhcc11_m = c(67,65,67,70,85,88,90,95,50,51,48,50,75,80,80,90),
                 rhcc11_p = c(38,45,48,58,65,70,72,82,42,46,46,48,70,68,70,76),
                 rhcc11_d = c(36,40,38,30,70,76,78,80,40,42,40,42,72,76,78,82),
                 rhcc12_m = c(60,62,63,64,81,87,88,90,40,45,46,47,70,78,78,83),
                 rhcc12_p = c(40,45,50,55,67,68,74,80,40,48,47,50,72,68,71,82),
                 rhcc12_d = c(38,39,38,33,75,78,83,82,38,42,40,42,68,80,78,82),
                 rhcc13 = c(15,NA,NA,NA,20,NA,NA,NA,35,NA,NA,NA,40,NA,NA,NA),
                 rhcc14 = c(75,NA,NA,NA,60,NA,NA,NA,85,NA,NA,NA,40,NA,NA,NA),
                 rhcc15 = c(85,NA,NA,NA,90,NA,NA,NA,95,NA,NA,NA,82,NA,NA,NA),
                 rhcc16 = c(50,NA,NA,60,68,NA,NA,75,34,NA,46,NA,30,NA,NA,NA),
                 rhcc17 = c(48,NA,NA,55,60,NA,NA,72,30,NA,41,NA,28,NA,NA,NA),
                 rhcc18 = c(54,NA,NA,60,64,NA,NA,70,28,NA,41,NA,32,NA,NA,NA),
                 #  `National Target` = c(),
                 `RHCC Target` = c(1000,1000,1000,1000,280,280,280,280,2750,2750,2750,2750,
                                   2086,2086,2086,2086))


palette = wes_palette("Darjeeling1")[c(1:3,5)]

line_plot = function(dat, date, kpi, ylab){
  ggplot(dat) + 
    geom_line(aes(x = date, y = {{kpi}}, color = adm0), size = 1.2) +
    geom_point(aes(x = date, y = {{kpi}}, color = adm0), size = 1.2) +
    scale_color_manual(values = palette) +
    labs(color = "Country", x ="Date", y = ylab) +
    theme_light()
}

bar_plot = function(dat, kpi, ylab){
  ggplot(dat %>%
           filter(!is.na({{kpi}})) %>%
           group_by(adm0)) + 
    geom_col(aes(y = {{kpi}}, x = adm0, fill = adm0), 
             position = position_dodge2(), width = 4) +
    scale_fill_manual(values = palette) +
    labs(fill = "Country", x ="Date", y = ylab) +
    scale_y_continuous(expand = c(0,0)) +
    theme_light()
}

dumbbell_plot = function(dat, kpi, ylab){
  ggplot(dat %>%
           filter(!is.na({{kpi}})) %>%
           group_by(adm0) %>%
           mutate(survey = as.factor(row_number())) %>%
           ungroup()) + 
    geom_point(aes(y = adm0, x = {{kpi}}, color = adm0, alpha = survey), size = 4) +
    geom_line(aes(y = adm0, x = {{kpi}}, group = adm0)) +
    scale_alpha_manual(values = c("1" = 1,"2" = 0.7,"3" = 0.4)) +
    scale_color_manual(values = palette) +
    labs(fill = "Country", x ="%", y = ylab, alpha = "Survey #", color = "Country") +
    theme_light() +
    xlim(c(0,100))
}

pie_chart = function(dat, kpi, ylab){
  ggplot(dat %>%
           group_by(adm0) %>%
           filter(!is.na({{kpi}})) %>%
           filter(row_number()==n()), 
         aes(x="", y = {{kpi}}, fill = adm0)) +
    geom_bar(stat="identity", width=1) +
    geom_text(aes(label = paste0({{kpi}}, "%")), position = position_stack(vjust=0.5)) +
    coord_polar("y", start=0) +
    ggforce::facet_wrap_paginate(~adm0, nrow = 2, ncol = 2) +
    scale_fill_manual(values = palette) +
    labs(fill = ylab, x ="", y = "") +
    theme_void()
}
```

# Multi-Country

ALL DATA DEPICTED IN THIS DASHBOARD ARE ENTIRELY FICTITIOUS. ANY SIMILARITY TO ACTUAL DATA IS PURELY COINCIDENTAL.


## Row 1

**RHCC1** - Under-5 Mortality per 1,000 Live Births

```{r}
ggplotly(line_plot(dat, date, rhcc1, "Under-5 mortality rate"))
```

## Row 2

### 
**RHCC2** - % of *Malaria* Cases Managed in the Community

```{r}
ggplotly(line_plot(dat, date, rhcc2m, "% of malaria cases managed in community") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

### 
**RHCC2** - % of *Pneumonia* Cases Managed in the Community

```{r}
ggplotly(line_plot(dat, date, rhcc2p, "% of pneumonia cases managed in community")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

### 
**RHCC2** - % of *Diarrhoea* Cases Managed in the Community

```{r}
ggplotly(line_plot(dat, date, rhcc2d, "% of diarrhoea cases managed in community")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

## Row 3

### 
**RHCC3** - # of CHWS Trained in iCCM

```{r}
ggplotly(bar_plot(dat, rhcc3, "# of CHWS Trained"))
```

### 
**RHCC4** - # of CHWs Equipped According to National Guidelines

```{r}
ggplotly(line_plot(dat, date, rhcc4, "# of CHWs Equipped"))
```

## Row 4 

### 
**RHCC5** - # of Clinical CHWs Trained and Deployed for iCCM per 1,000 children under-five in RHCC areas

```{r}
ggplotly(bar_plot(dat, rhcc5_n/rhcc5_d*1000, "# of CHWs per 1,000 children under 5") +
           scale_y_continuous(lim = c(0,15), expand = c(0,0)))
```

### 
**RHCC5** - # of Clinical CHWs Trained and Deployed for iCCM

```{r}
ggplotly(ggplot(dat %>%
                 filter(!is.na(rhcc5_n)) %>%
                 group_by(adm0)) + 
          geom_col(aes(y = RHCC.Target, x = adm0, fill = adm0, alpha = "RHCC target"), 
                   position = position_dodge2(), width = 4) +
          geom_col(aes(y = rhcc5_n, x = adm0, fill = adm0, alpha = "Achieved"), 
                   position = position_dodge2(), width = 4) +
          scale_fill_manual(values = palette) +
          scale_alpha_manual(values = c("RHCC target" = 0.5, "Achieved" = 1)) +
          labs(fill = "Country", x ="Date", y = "# of CHWs", alpha = "") +
          scale_y_continuous(expand = c(0,0)) +
          theme_light())
```

### 
**RHCC6** - # of CHW Supervisors Trained

```{r}
ggplotly(bar_plot(dat, rhcc6, "# of CHW supervisors trained"))
```

## Row 5 

### 
**RHCC7** - % of CHWs Who Received At Least One Supervisory Contact in the Prior Month

```{r}
ggplotly(line_plot(dat, date, rhcc7, "% of CHWs with supervisory contact during prior month")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```


### 
**RHCC8** - % of CHWs Who Correctly Count Respiratory Rate to Diagnose ARI

```{r}
ggplotly(line_plot(dat, date, rhcc8, "# of CHWs correctly counting respiratory rate")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

## Row 6

### 
**RHCC9** - % of Sick Child Cases Recommended for Referral by CHW

```{r}
ggplotly(line_plot(dat, date, rhcc9, "% of sick child cases referred")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

### 
**RHCC9.1** - % of Sick Children Referred by CHWs Who are Received at Referral Facility

```{r}
ggplotly(line_plot(dat, date, rhcc9.1, "% of referrals received")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

## Row 7 

 **RHCC10** - % of CHWs Trained in iCCM Who Are Providing iCCM 1 Year After Initial Training

```{r}
ggplotly(bar_plot(dat, rhcc10, "% of CHWs providing iCCM 1 year after initial training")+
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

## Row 8 

### 
**RHCC11** - % of iCCM Sites/Outreach Posts with No Stock-outs of Key *Malaria* Medicines and Diagnostics in the Past Month

```{r}
ggplotly(line_plot(dat, date, rhcc11_m, "% of iCCM sites/outreach posts with no stock-outs") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

### 
**RHCC11** - % of iCCM Sites/Outreach Posts with No Stock-outs of Key *Pneumonia* Medicines and Diagnostics in the Past Month

```{r}
ggplotly(line_plot(dat, date, rhcc11_p, "% of iCCM sites/outreach posts with no stock-outs") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

###
**RHCC11** - % of iCCM Sites/Outreach Posts with No Stock-outs of Key *Diarrhoea* Medicines and Diagnostics in the Past Month

```{r}
ggplotly(line_plot(dat, date, rhcc11_d, "% of iCCM sites/outreach posts with no stock-outs") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

## Row 9

### 
**RHCC12** - % of CHWs Who Had No Stock-outs of *Malaria* Commodities During the Reporting Period

```{r}
ggplotly(line_plot(dat, date, rhcc12_m, "% of CHWs with no stock-outs") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

### 
**RHCC12** - % of CHWs Who Had No Stock-outs of *Pneumonia* Commodities During the Reporting Period

```{r}
ggplotly(line_plot(dat, date, rhcc12_p, "% of CHWs with no stock-outs") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

### 
**RHCC12** - % of CHWs Who Had No Stock-outs of *Diarrhoea* Commodities During the Reporting Period

```{r}
ggplotly(line_plot(dat, date, rhcc12_d, "% of CHWs with no stock-outs") +
           scale_y_continuous(lim = c(0,100), expand = c(0,0)))
```

## Row 10 

### 
**RHCC13** - % of Reports Submitted on Time

```{r}
pie_chart(dat, rhcc13, "% on time")
```

### 
**RHCC14** - % of Accurate Reports Submitted

```{r}
pie_chart(dat, rhcc14, "% accurate")
```

### 
**RHCC15** - % of Complete Reports Submitted

```{r}
pie_chart(dat, rhcc15, "% complete")
```

## Row 11 {data-height=50}

Caregivers of children under-5 were surveyed at baseline and endline to ascertain their knowledge of iCCM services, the location of their CHW, and warning signs of childhood illnesses that necessitate immediate medical attention.

## Row 12

###
**RHCC16** - % of Caregivers Aware of iCCM Services

```{r}
ggplotly(dumbbell_plot(dat, rhcc16, "% of caregivers aware of iCCM services"))
```

### 
**RHCC17** - % of Caregivers Who Know the Location of Their CHW

```{r}
ggplotly(dumbbell_plot(dat, rhcc17, "% of caregivers who know CCM location"))
```

###
**RHCC18** - % of Caregivers Who Know Two or More Signs of Childhood Illness That Require Immediate Assessment and, if Appropriate, Treatment

```{r}
ggplotly(dumbbell_plot(dat, rhcc18, "% of caregivers who know warning signs"))
```

# DRC

```{r}
#There are a couple figure functions up in the first chunk. To whatever extent we can functionize figures, that'd be great!

#I figured it would be good to use a different palette for each page, so it's more obvious if you've switched tabs. I've been using Wes Anderson for the main page. They're here in case useful: https://github.com/karthik/wesanderson
palette_drc = ""

# #Four months of fake DRC data
# drc = data.frame(adm0 = rep("DRC", each = 4*14), 
#                  adm1 = rep("Kasai", each = 4*14),
#                  adm2 = rep(c("Tshikapa", "Kalonda West", "Kamonia", "Kamwesha", "Kanzala", "Kitangwa", "Mikope", "Banga" "Lubaka", "Nyanga", "Luebo", "Mutena", "Njokopunda", "Bulape", "Kakenge"), each = 4),
#                  date = rep(c(seq.Date(from = "2020-01-01", to = "2020-04-01", by = "month")), times = 14)),
#                  rhcc1 = ,
#                  rhcc2 = ,
#                  rhcc3 = ,
#                  rhcc4 = ,
#                  rhcc5 = ,
#                  rhcc6 = ,
#                  rhcc7 = ,
#                  rhcc8 = ,
#                  rhcc9 = ,
#                  rhcc10 = ,
#                  rhcc11 = ,
#                  rhcc12 = ,
#                  rhcc13 = ,
#                  rhcc14 = ,
#                  rhcc15 = ,
#                  rhcc16 = ,
#                  rhcc17 = ,
#                  rhcc18 = )

```

# Mozambique

```{r}

```

# Nigeria

```{r}

```

# Zambia

```{r}

```

# KPI definitions

```{r}
data.frame(KPI = c("RHCC1","RHCC2","RHCC3","RHCC4","RHCC5","RHCC6","RHCC7","RHCC8","RHCC9","RHCC9.1","RHCC10","RHCC11","RHCC12","RHCC13","RHCC14","RHCC15","RHCC16","RHCC17","RHCC18"), 
           Description = c("Under-five mortality rate in RHCC project areas",
                           "% of cases managed at community level",
                           "# of CHWs trained",
                           "# of trained CHWs equipped according to national guidelines",
                           "# of CHWs trained and deployed for iCCM per 1,000 children under-five in RHCC areas",
                           "# of CHW supervisors trained",
                           "% of CHWs who received at least one supervisory contact in the prior month (where registers were reviewed)",
                           "% of CHWs who correctly count respiratory rate to diagnose ARI",
                           "% of sick child cases recommended for referral by CHW",
                           "% of sick children referred by CHWs who are received at referral facility",
                           "% of CHWs trained in iCCM who are providing iCCM 1 year after initial training",
                           "% of iCCM sites/outreach posts with no stock-outs of key iCCM medicines and diagnostics in the past month",
                           "% of CHWs who had no stock-outs of commodities during the reporting period",
                           "% of reports submitted on time",
                           "% of accurate reports submitted",
                           "% of complete reports submitted",
                           "% of community members aware of iCCM services",
                           "% of community members who know the location of their CHW",
                           "% of caregivers who know two or more signs of childhood illness that require immediate assessment and, if appropriate, treatment"),
           `Disaggregation` = c("",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "disease",
                           "disease",
                           "",
                           "",
                           "",
                           "",
                           "",
                           "")) %>%
  kable()
```
